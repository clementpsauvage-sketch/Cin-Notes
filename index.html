<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cin√©Notes</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="apple-touch-icon" href="web-app-manifest-192x192.png">
</head>
<body>

    <div class="container">
        <header>
            <h1>üé¨ Cin√©Notes</h1>
            <nav class="main-nav">
                <button onclick="showPage('add')" id="btn-nav-add" class="active">Accueil</button>
                <button onclick="showPage('history')" id="btn-nav-history">üìú Historique</button>
                <button id="btn-notif" style="background-color: #444;">üîî Activer Alertes</button>
            </nav>
        </header>

        <main>
            <div id="page-add">
                <section class="card add-section">
                    <form id="movie-form">
                        <input type="text" id="movie-title" placeholder="Nom du film..." required>
                        <button type="submit" id="search-btn">üîç</button>
                    </form>
                    
                    <div id="result-preview" class="result-box hidden">
                        <p>üé¨ <strong id="director-name">...</strong></p>
                        <button id="save-movie">Ajouter au journal</button>
                    </div>
                </section>

                <section class="list-section">
                    <h2>Films √† faire</h2>
                    <div id="list-container"></div>
                </section>
            </div>

            <div id="page-history" class="hidden">
                <section class="card">
                    <input type="text" id="search-history" placeholder="Rechercher un film ou un r√©alisateur..." oninput="renderHistory()">
                </section>
                <section class="list-section">
                    <h2>Films termin√©s</h2>
                    <div id="done-container"></div>
                </section>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script type = "module" src="app2.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmMzx6MK7GyxQ5GbU6BR2Fdc2hEple-mc",
            authDomain: "notes-app-zenith-99.firebaseapp.com",
            projectId: "notes-app-zenith-99",
            storageBucket: "notes-app-zenith-99.firebasestorage.app",
            messagingSenderId: "977687759982",
            appId: "1:977687759982:web:cf6bb4e98326086b482a7f"
        };
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        const notifBtn = document.getElementById('btn-notif');

        notifBtn.addEventListener('click', async () => {
            if (!('serviceWorker' in navigator)) return;

            try {
                // Force la demande de permission suite au clic
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    const registration = await navigator.serviceWorker.register('firebase-messaging-sw.js');
                    const token = await getToken(messaging, { 
                        serviceWorkerRegistration: registration,
                        vapidKey: 'BCtxIqYwzmloUnM1gVkhDa1SpmsGua0y0snDy8O7ZI1CNDl1JXyGdBMSc1f6yMfUo3drFN4ZlsAVapQtpYJbT2E' 
                    });

                    if (token) {
                        localStorage.setItem('fcm_token', token);
                        alert("Notifications activ√©es !");
                        notifBtn.style.display = 'none'; // On cache le bouton apr√®s succ√®s
                    }
                } else {
                    alert("Vous avez refus√© les notifications.");
                }
            } catch (err) {
                console.error('Erreur iOS:', err);
                alert("Erreur : Assurez-vous d'avoir ajout√© l'app √† l'√©cran d'accueil.");
            }
        });
    </script>
    </body>
</html>